# Unified Web3 & Content Production Platform

## Overview

A unified application combining two systems:
1. **Web3 Wallet Tools**: Address comparison, NFT collection management, and address extraction for Web3 users
2. **ContentFlowStudio**: Content production management system with task tracking, team directory, and deliverables for content teams

The application uses internal email/password authentication with strict role-based access control:
- **web3 users**: Only see wallet address tools and NFT features
- **content users**: Only see content production management features
- **admin users**: Full access to both sides + invite code generation

Admin access requires a secure invite code system where only existing admins can generate codes for new admins.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Authentication

**Internal Email/Password Authentication**:
- Session-based auth with PostgreSQL session store
- Passwords hashed using bcryptjs (10 salt rounds)
- No external OAuth dependencies

**Auth Endpoints**:
- POST `/api/auth/register` - Register with email, password, firstName, lastName
- POST `/api/auth/login` - Login with email and password
- POST `/api/logout` - Destroy session and logout
- GET `/api/auth/user` - Get current authenticated user
- PATCH `/api/auth/role` - Update user role

**User Roles** (stored in users.role field):
- `web3`: Access to Compare, Extract, Collections, History, To Do pages
- `content`: Access to Content Dashboard with tasks and team directory
- `admin`: Access to all features from both sides + invite code generation

**Admin Invite Code System**:
- Admin role requires a valid invite code during role selection
- Codes are single-use and can only be generated by existing admins
- Initial admin code set via `INITIAL_ADMIN_CODE` environment variable
- Admin invite codes page (`/admin/codes`) for code management

**Role Selection**: First-time users see role selection page; can change role later via user menu

### Frontend Architecture

**Framework**: React with TypeScript using Vite as the build tool.

**Routing**: Uses Wouter for lightweight client-side routing with role-based route protection.

**UI Component Library**: Shadcn UI (New York style) with Radix UI primitives.

**Key Pages**:
- `/role-select`: Role selection for new users
- `/compare`: Web3 address comparison tool (web3/admin)
- `/extract`: EVM address extraction from files (web3/admin)
- `/collections`: NFT collection management (web3/admin)
- `/history`: Comparison history (web3/admin)
- `/todo`: Personal to-do list (web3/admin)
- `/content`: Content production dashboard (content/admin)
- `/admin/codes`: Admin invite code management (admin only)

### Backend Architecture

**Runtime**: Node.js with Express server

**API Endpoints**:

Web3 Endpoints:
- POST `/api/compare` - Upload and compare two files
- POST `/api/compare-collection` - Compare eligible file against stored collection
- POST `/api/extract` - Extract EVM addresses from any file
- GET/POST/DELETE `/api/collections` - NFT collection CRUD
- GET/POST/DELETE `/api/collections/:id/addresses` - Collection addresses
- GET `/api/comparisons` - Comparison history

Auth Endpoints:
- GET `/api/auth/user` - Get current user
- POST `/api/auth/register` - Register new user
- POST `/api/auth/login` - Login with email/password
- POST `/api/logout` - Log out
- PATCH `/api/auth/role` - Update user role (admin requires invite code)

Admin Invite Code Endpoints (admin only):
- POST `/api/admin/invite-codes` - Generate new invite code
- GET `/api/admin/invite-codes` - List codes generated by current admin
- DELETE `/api/admin/invite-codes/:id` - Deactivate an invite code
- POST `/api/admin/validate-code` - Validate an invite code (public)

ContentFlowStudio Endpoints:
- GET/POST/PUT/DELETE `/api/content-tasks` - Content task CRUD
- GET/POST/PUT/DELETE `/api/directory` - Team directory CRUD
- GET/POST/DELETE `/api/deliverables` - Deliverable file management
- POST `/api/content-tasks/:id/deliverables` - Upload task deliverable

To-Do Endpoints:
- GET/POST/PATCH/DELETE `/api/tasks` - Personal task CRUD

### Database Schema

**Users table** (for internal auth):
- id (varchar): UUID primary key
- email (varchar): Unique email
- password (varchar): Hashed password (bcrypt)
- firstName, lastName, profileImageUrl (varchar)
- role (varchar): "web3", "content", or "admin"
- createdAt, updatedAt (timestamp)

**Sessions table** (for session storage):
- sid (varchar): Session ID primary key
- sess (jsonb): Session data
- expire (timestamp): Session expiration

**Collections table** (NFT minted address collections):
- id (serial): Primary key
- name (text): Unique collection name
- description (text): Optional description
- createdAt (timestamp)

**Minted Addresses table**:
- id (serial): Primary key
- collectionId (integer): FK to collections (cascade delete)
- address (text): Lowercase EVM address
- createdAt (timestamp)

**Comparisons table** (comparison history):
- id (serial): Primary key
- collectionId (integer): Optional FK to collections
- mintedFileName, eligibleFileName (varchar)
- totalEligible, totalMinted, remaining, invalidAddresses (integer)
- results (jsonb): Full comparison results
- createdAt (timestamp)

**Tasks table** (personal to-do):
- id (serial): Primary key
- userId (varchar): FK to users (cascade delete)
- title (text), status (text), isPublic (boolean)
- createdAt (timestamp)

**Content Tasks table** (ContentFlowStudio):
- id (serial): Primary key
- description (text): Task description
- status (varchar): "TO BE STARTED", "IN PROGRESS", "COMPLETED"
- assignedTo, dueDate, assignedBy, client, deliverable, notes (varchar/text)
- createdAt (timestamp)

**Directory Members table** (team directory):
- id (serial): Primary key
- person (varchar): Person name
- skill (text): Skills/roles
- evmAddress (varchar): Optional EVM address
- client (varchar): Associated client

**Deliverables table** (task file uploads):
- id (serial): Primary key
- taskId (integer): FK to content_tasks (cascade delete)
- fileName (varchar), filePath (text), fileSize (varchar)
- uploadedAt (timestamp)

**Admin Invite Codes table** (for admin role access):
- id (serial): Primary key
- code (varchar): Unique invite code
- createdBy (varchar): FK to users (nullable for initial code)
- usedBy (varchar): FK to users (nullable until used)
- usedAt (timestamp): When code was used
- expiresAt (timestamp): Code expiration (7 days default)
- isActive (boolean): Whether code is still valid
- createdAt (timestamp)

### External Dependencies

**Authentication**:
- bcryptjs: Password hashing
- express-session, connect-pg-simple: Session management

**UI Components**:
- Radix UI primitives (@radix-ui/*)
- Lucide React icons
- Shadcn UI components

**Data Processing**:
- PapaParse: CSV parsing
- xlsx: Excel file parsing
- pdf-parse: PDF text extraction
- Multer: File upload handling

**Database**:
- Drizzle ORM with PostgreSQL
- @neondatabase/serverless driver

## Recent Changes (November 26, 2025)

### Google Drive & Sheets Integration Enhancements (Session 4)

1. **Google Drive File Upload Integration**:
   - Deliverable uploads now automatically upload to Google Drive
   - Creates shareable "anyone with link" public URLs
   - Falls back to local storage if Drive not configured
   - Drive links stored in task's deliverable field for sync
   - File size limit: 50MB for memory safety
   - Required scope: `https://www.googleapis.com/auth/drive.file`

2. **Persistent Google Sheet Connection**:
   - Sheet ID stored in `GOOGLE_SHEET_ID` environment variable
   - Auto-connects on startup/status check - no manual reconnection needed
   - Simplified Settings UI (no need to re-enter sheet ID)

3. **Sheet Name Case Sensitivity Fix**:
   - Sheet tabs now correctly use uppercase names: "TASKS" and "DIRECTORY"
   - Fixed directory sync error when sheet already exists

4. **Environment Variables for Google Integration**:
   - `GOOGLE_SERVICE_ACCOUNT_EMAIL` - Service account email
   - `GOOGLE_PRIVATE_KEY` - Service account private key
   - `GOOGLE_SHEET_ID` - Google Sheet ID (persistent)
   - `GOOGLE_DRIVE_FOLDER_ID` - Optional: specific Drive folder for uploads

## Recent Changes (November 25, 2025)

### Enhanced ContentFlowStudio Features (Session 3)

1. **Email Notification System**:
   - Nodemailer-based email service for task notifications
   - Sends emails on task assignment (when task is created or assignee changes)
   - Automated due date reminder system running hourly
   - Sends "due soon" emails 3 days before due date
   - Sends "overdue" emails when tasks pass due date
   - Graceful handling when SMTP credentials not configured
   - API endpoint: POST `/api/test-email` for testing
   - Required environment variables: SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM

2. **Improved Google Sheets Integration**:
   - Enhanced Settings UI with collapsible setup instructions
   - Sheet ID input field - accepts full URLs or just the ID
   - Credential status indicators (configured vs not configured)
   - Service account email display when credentials are set
   - Disconnect functionality to clear sheet connection
   - API endpoint: POST `/api/sheets/disconnect`

3. **Bug Fixes**:
   - Fixed "Add Task" dialog crash caused by empty SelectItem value
   - Changed campaign "None" option from empty string to "none" value

### Enhanced ContentFlowStudio Features (Session 2)

1. **Multiple Task Views**:
   - Grid view: Traditional card-based task display
   - Kanban view: Drag-and-drop columns for status changes
   - Calendar view: Tasks organized by due date on monthly calendar
   - View mode switcher in Tasks tab

2. **Subtasks/Checklist System**:
   - Add subtasks to any content task
   - Track completion progress with checkboxes
   - Progress bar showing subtask completion percentage
   - API endpoints: GET/POST `/api/content-tasks/:id/subtasks`, PATCH/DELETE `/api/subtasks/:id`

3. **Comments & Collaboration**:
   - Threaded comments with replies on tasks
   - User attribution with avatars
   - Edit and delete own comments
   - API endpoints: GET/POST `/api/content-tasks/:id/comments`, PATCH/DELETE `/api/comments/:id`

4. **Activity Timeline**:
   - Complete history of task changes
   - Tracks status changes, assignments, priority changes, subtask actions
   - User-attributed activity entries with timestamps
   - API endpoint: GET `/api/content-tasks/:id/activity`

5. **Analytics Dashboard**:
   - Task status distribution (pie chart)
   - Priority breakdown (bar chart)
   - Team workload by assignee
   - Client distribution
   - Campaign progress tracking
   - Quick summary stats

6. **In-App Notification System**:
   - Bell icon in navigation header with unread count
   - Notification types: assignment, comment, due_soon, overdue
   - Mark as read individual or all
   - Auto-created on task assignment and comments
   - API endpoints: GET `/api/notifications`, GET `/api/notifications/unread-count`, PATCH `/api/notifications/:id/read`, PATCH `/api/notifications/read-all`

### Previous Features (Session 1)

1. **Google Sheets Integration**:
   - Bidirectional sync with Google Sheets for content task management
   - Settings tab in content dashboard with connect/push/pull controls
   - Service account authentication using GOOGLE_SERVICE_ACCOUNT_EMAIL and GOOGLE_PRIVATE_KEY
   - server/google-sheets.ts service for Sheets API communication
   - API endpoints: POST `/api/sheets/connect`, GET `/api/sheets/status`, POST `/api/sheets/push`, POST `/api/sheets/pull`
2. **Overdue Task Highlighting**:
   - Visual indicators for overdue tasks (red border/background)
   - Visual indicators for due-soon tasks (amber, within 3 days)
   - Completed tasks excluded from overdue highlighting
   - AlertTriangle icon for overdue due dates
3. **Deliverables Tab Restored**:
   - Fixed Deliverables tab in content dashboard
   - Linked to content tasks (not personal tasks)
   - File upload per task with proper API integration
4. **Admin Invite Code System**:
   - Admin role now requires a valid invite code during role selection
   - Single-use codes that expire after 7 days
   - Only existing admins can generate new codes
   - Initial bootstrap via INITIAL_ADMIN_CODE environment variable
   - Admin invite codes management page at `/admin/codes`
5. **Internal Authentication**: Replaced Google OAuth with email/password authentication
   - Registration and login forms with validation
   - Passwords hashed with bcryptjs (10 salt rounds)
   - Session-based authentication with PostgreSQL session store
   - Added password column to users table
6. **Role-Based Access Control**: 
   - Three roles: web3, content, admin
   - Role selection page for new users
   - Role-based navigation showing only relevant features
   - Server-side middleware protection: `requireRole("content")` for all ContentFlowStudio endpoints
   - Frontend route protection: All routes require authentication
7. **ContentFlowStudio Integration**:
   - Content Tasks page with filtering and bulk actions
   - Team Directory with skills and EVM addresses
   - Deliverable file uploads per task
8. **Database Schema Updates**:
   - Added password and role fields to users table
   - Added content_tasks, directory_members, deliverables tables
   - Added admin_invite_codes table for secure admin access
9. **Security Hardening**:
   - All protected routes redirect to sign-in page for unauthenticated users
   - Backend API routes enforce role-based access with middleware
   - Admin role has access to all features from both systems

## Previous Changes (November 24, 2025)

1. **Ethereum Address Validation**: Format validation with error reporting
2. **PostgreSQL Database**: Drizzle ORM with persistent storage
3. **Comparison History**: History page with past results
4. **Multi-Format File Support**: CSV, TXT, JSON, Excel parsing
