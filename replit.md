# Unified Web3 & Content Production Platform

## Overview

A unified application combining two systems:
1. **Web3 Wallet Tools**: Address comparison, NFT collection management, and address extraction for Web3 users
2. **ContentFlowStudio**: Content production management system with task tracking, team directory, and deliverables for content teams

The application uses internal email/password authentication with strict role-based access control:
- **web3 users**: Only see wallet address tools and NFT features
- **content users**: Only see content production management features
- **admin users**: Full access to both sides + invite code generation

Admin access requires a secure invite code system where only existing admins can generate codes for new admins.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Authentication

**Internal Email/Password Authentication**:
- Session-based auth with PostgreSQL session store
- Passwords hashed using bcryptjs (10 salt rounds)
- No external OAuth dependencies

**Auth Endpoints**:
- POST `/api/auth/register` - Register with email, password, firstName, lastName
- POST `/api/auth/login` - Login with email and password
- POST `/api/logout` - Destroy session and logout
- GET `/api/auth/user` - Get current authenticated user
- PATCH `/api/auth/role` - Update user role

**User Roles** (stored in users.role field):
- `web3`: Access to Compare, Extract, Collections, History, To Do pages
- `content`: Access to Content Dashboard with tasks and team directory
- `admin`: Access to all features from both sides + invite code generation

**Admin Invite Code System**:
- Admin role requires a valid invite code during role selection
- Codes are single-use and can only be generated by existing admins
- Initial admin code set via `INITIAL_ADMIN_CODE` environment variable
- Admin invite codes page (`/admin/codes`) for code management

**Role Selection**: First-time users see role selection page; can change role later via user menu

### Frontend Architecture

**Framework**: React with TypeScript using Vite as the build tool.

**Routing**: Uses Wouter for lightweight client-side routing with role-based route protection.

**UI Component Library**: Shadcn UI (New York style) with Radix UI primitives.

**Key Pages**:
- `/role-select`: Role selection for new users
- `/compare`: Web3 address comparison tool (web3/admin)
- `/extract`: EVM address extraction from files (web3/admin)
- `/collections`: NFT collection management (web3/admin)
- `/history`: Comparison history (web3/admin)
- `/todo`: Personal to-do list (web3/admin)
- `/content`: Content production dashboard (content/admin)
- `/admin/codes`: Admin invite code management (admin only)

### Backend Architecture

**Runtime**: Node.js with Express server

**API Endpoints**:

Web3 Endpoints:
- POST `/api/compare` - Upload and compare two files
- POST `/api/compare-collection` - Compare eligible file against stored collection
- POST `/api/extract` - Extract EVM addresses from any file
- GET/POST/DELETE `/api/collections` - NFT collection CRUD
- GET/POST/DELETE `/api/collections/:id/addresses` - Collection addresses
- GET `/api/comparisons` - Comparison history

Auth Endpoints:
- GET `/api/auth/user` - Get current user
- POST `/api/auth/register` - Register new user
- POST `/api/auth/login` - Login with email/password
- POST `/api/logout` - Log out
- PATCH `/api/auth/role` - Update user role (admin requires invite code)

Admin Invite Code Endpoints (admin only):
- POST `/api/admin/invite-codes` - Generate new invite code
- GET `/api/admin/invite-codes` - List codes generated by current admin
- DELETE `/api/admin/invite-codes/:id` - Deactivate an invite code
- POST `/api/admin/validate-code` - Validate an invite code (public)

ContentFlowStudio Endpoints:
- GET/POST/PUT/DELETE `/api/content-tasks` - Content task CRUD
- GET/POST/PUT/DELETE `/api/directory` - Team directory CRUD
- GET/POST/DELETE `/api/deliverables` - Deliverable file management
- POST `/api/content-tasks/:id/deliverables` - Upload task deliverable

To-Do Endpoints:
- GET/POST/PATCH/DELETE `/api/tasks` - Personal task CRUD

### Database Schema

**Users table** (for internal auth):
- id (varchar): UUID primary key
- email (varchar): Unique email
- password (varchar): Hashed password (bcrypt)
- firstName, lastName, profileImageUrl (varchar)
- role (varchar): "web3", "content", or "admin"
- createdAt, updatedAt (timestamp)

**Sessions table** (for session storage):
- sid (varchar): Session ID primary key
- sess (jsonb): Session data
- expire (timestamp): Session expiration

**Collections table** (NFT minted address collections):
- id (serial): Primary key
- name (text): Unique collection name
- description (text): Optional description
- createdAt (timestamp)

**Minted Addresses table**:
- id (serial): Primary key
- collectionId (integer): FK to collections (cascade delete)
- address (text): Lowercase EVM address
- createdAt (timestamp)

**Comparisons table** (comparison history):
- id (serial): Primary key
- collectionId (integer): Optional FK to collections
- mintedFileName, eligibleFileName (varchar)
- totalEligible, totalMinted, remaining, invalidAddresses (integer)
- results (jsonb): Full comparison results
- createdAt (timestamp)

**Tasks table** (personal to-do):
- id (serial): Primary key
- userId (varchar): FK to users (cascade delete)
- title (text), status (text), isPublic (boolean)
- createdAt (timestamp)

**Content Tasks table** (ContentFlowStudio):
- id (serial): Primary key
- description (text): Task description
- status (varchar): "TO BE STARTED", "IN PROGRESS", "COMPLETED"
- assignedTo, dueDate, assignedBy, client, deliverable, notes (varchar/text)
- createdAt (timestamp)

**Directory Members table** (team directory):
- id (serial): Primary key
- person (varchar): Person name
- skill (text): Skills/roles
- evmAddress (varchar): Optional EVM address
- client (varchar): Associated client

**Deliverables table** (task file uploads):
- id (serial): Primary key
- taskId (integer): FK to content_tasks (cascade delete)
- fileName (varchar), filePath (text), fileSize (varchar)
- uploadedAt (timestamp)

**Admin Invite Codes table** (for admin role access):
- id (serial): Primary key
- code (varchar): Unique invite code
- createdBy (varchar): FK to users (nullable for initial code)
- usedBy (varchar): FK to users (nullable until used)
- usedAt (timestamp): When code was used
- expiresAt (timestamp): Code expiration (7 days default)
- isActive (boolean): Whether code is still valid
- createdAt (timestamp)

### External Dependencies

**Authentication**:
- bcryptjs: Password hashing
- express-session, connect-pg-simple: Session management

**UI Components**:
- Radix UI primitives (@radix-ui/*)
- Lucide React icons
- Shadcn UI components

**Data Processing**:
- PapaParse: CSV parsing
- xlsx: Excel file parsing
- pdf-parse: PDF text extraction
- Multer: File upload handling

**Database**:
- Drizzle ORM with PostgreSQL
- @neondatabase/serverless driver

## Recent Changes (November 25, 2025)

1. **Admin Invite Code System**:
   - Admin role now requires a valid invite code during role selection
   - Single-use codes that expire after 7 days
   - Only existing admins can generate new codes
   - Initial bootstrap via INITIAL_ADMIN_CODE environment variable
   - Admin invite codes management page at `/admin/codes`
2. **Internal Authentication**: Replaced Google OAuth with email/password authentication
   - Registration and login forms with validation
   - Passwords hashed with bcryptjs (10 salt rounds)
   - Session-based authentication with PostgreSQL session store
   - Added password column to users table
3. **Role-Based Access Control**: 
   - Three roles: web3, content, admin
   - Role selection page for new users
   - Role-based navigation showing only relevant features
   - Server-side middleware protection: `requireRole("content")` for all ContentFlowStudio endpoints
   - Frontend route protection: All routes require authentication
4. **ContentFlowStudio Integration**:
   - Content Tasks page with filtering and bulk actions
   - Team Directory with skills and EVM addresses
   - Deliverable file uploads per task
5. **Database Schema Updates**:
   - Added password and role fields to users table
   - Added content_tasks, directory_members, deliverables tables
   - Added admin_invite_codes table for secure admin access
6. **Security Hardening**:
   - All protected routes redirect to sign-in page for unauthenticated users
   - Backend API routes enforce role-based access with middleware
   - Admin role has access to all features from both systems

## Previous Changes (November 24, 2025)

1. **Ethereum Address Validation**: Format validation with error reporting
2. **PostgreSQL Database**: Drizzle ORM with persistent storage
3. **Comparison History**: History page with past results
4. **Multi-Format File Support**: CSV, TXT, JSON, Excel parsing
